{"version":3,"file":"VVirtualScroll.mjs","names":["VVirtualScrollItem","makeDimensionProps","useDimension","useDisplay","useResizeObserver","computed","onMounted","ref","watchEffect","convertToUnit","createRange","genericComponent","useRender","UP","DOWN","VVirtualScroll","name","props","items","type","Array","default","itemHeight","Number","String","visibleItems","setup","slots","first","baseItemHeight","get","parseInt","value","set","val","rootEl","resizeRef","contentRect","display","sizes","length","map","Math","max","ceil","height","handleItemResize","index","calculateOffset","slice","reduce","curr","calculateMidPointIndex","scrollTop","start","end","middle","floor","middleOffset","lastScrollTop","handleScroll","direction","midPointIndex","buffer","round","min","scrollToIndex","offset","last","computedItems","paddingTop","paddingBottom","dimensionStyles","item"],"sources":["../../../src/labs/VVirtualScroll/VVirtualScroll.tsx"],"sourcesContent":["// Styles\nimport './VVirtualScroll.sass'\n\n// Components\nimport { VVirtualScrollItem } from './VVirtualScrollItem'\n\n// Composables\nimport { makeDimensionProps, useDimension } from '@/composables/dimensions'\nimport { useDisplay } from '@/composables/display'\nimport { useResizeObserver } from '@/composables/resizeObserver'\n\n// Utilities\nimport { computed, onMounted, ref, watchEffect } from 'vue'\nimport {\n  convertToUnit,\n  createRange,\n  genericComponent,\n  useRender,\n} from '@/util'\n\n// Types\nimport type { SlotsToProps } from '@/util'\n\nconst UP = -1\nconst DOWN = 1\n\nexport interface VVirtualScrollSlot<T> {\n  item: T\n  index: number\n}\n\nexport const VVirtualScroll = genericComponent<new <T>() => {\n  $props: {\n    items: readonly T[]\n  } & SlotsToProps<{\n    default: [VVirtualScrollSlot<T>]\n  }>\n}>()({\n  name: 'VVirtualScroll',\n\n  props: {\n    items: {\n      type: Array,\n      default: () => ([]),\n    },\n    itemHeight: [Number, String],\n    visibleItems: [Number, String],\n\n    ...makeDimensionProps(),\n  },\n\n  setup (props, { slots }) {\n    const first = ref(0)\n    const baseItemHeight = ref(props.itemHeight)\n    const itemHeight = computed({\n      get: () => parseInt(baseItemHeight.value ?? 0, 10),\n      set (val) {\n        baseItemHeight.value = val\n      },\n    })\n    const rootEl = ref<HTMLDivElement>()\n    const { resizeRef, contentRect } = useResizeObserver()\n    watchEffect(() => {\n      resizeRef.value = rootEl.value\n    })\n    const display = useDisplay()\n\n    const sizes = createRange(props.items.length).map(() => itemHeight.value)\n    const visibleItems = computed(() => {\n      return props.visibleItems\n        ? parseInt(props.visibleItems, 10)\n        : Math.max(12,\n          Math.ceil(((contentRect.value?.height ?? display.height.value) / itemHeight.value) * 1.7 + 1)\n        )\n    })\n\n    function handleItemResize (index: number, height: number) {\n      itemHeight.value = Math.max(itemHeight.value, height)\n      sizes[index] = height\n    }\n\n    function calculateOffset (index: number) {\n      return sizes.slice(0, index).reduce((curr, value) => curr + (value || itemHeight.value), 0)\n    }\n\n    function calculateMidPointIndex (scrollTop: number) {\n      let start = 0\n      let end = props.items.length\n\n      while (start <= end) {\n        const middle = start + Math.floor((end - start) / 2)\n        const middleOffset = calculateOffset(middle)\n\n        if (middleOffset === scrollTop) {\n          return middle\n        } else if (middleOffset < scrollTop) {\n          start = middle + 1\n        } else if (middleOffset > scrollTop) {\n          end = middle - 1\n        }\n      }\n\n      return start\n    }\n\n    let lastScrollTop = 0\n    function handleScroll () {\n      if (!rootEl.value || !contentRect.value) return\n\n      const height = contentRect.value.height\n      const scrollTop = rootEl.value.scrollTop\n      const direction = scrollTop < lastScrollTop ? UP : DOWN\n\n      const midPointIndex = calculateMidPointIndex(scrollTop + height / 2)\n      const buffer = Math.round(visibleItems.value / 3)\n      if (direction === UP && midPointIndex <= first.value + (buffer * 2) - 1) {\n        first.value = Math.max(midPointIndex - buffer, 0)\n      } else if (direction === DOWN && midPointIndex >= first.value + (buffer * 2) - 1) {\n        first.value = Math.min(Math.max(0, midPointIndex - buffer), props.items.length - visibleItems.value)\n      }\n\n      lastScrollTop = rootEl.value.scrollTop\n    }\n\n    function scrollToIndex (index: number) {\n      if (!rootEl.value) return\n\n      const offset = calculateOffset(index)\n      rootEl.value.scrollTop = offset\n    }\n\n    const last = computed(() => Math.min(props.items.length, first.value + visibleItems.value))\n    const computedItems = computed(() => props.items.slice(first.value, last.value))\n    const paddingTop = computed(() => calculateOffset(first.value))\n    const paddingBottom = computed(() => calculateOffset(props.items.length) - calculateOffset(last.value))\n\n    const { dimensionStyles } = useDimension(props)\n\n    onMounted(() => {\n      if (!itemHeight.value) {\n        // If itemHeight prop is not set, then calculate an estimated height from the average of inital items\n        itemHeight.value = sizes.slice(first.value, last.value).reduce((curr, height) => curr + height, 0) / (visibleItems.value)\n      }\n    })\n\n    useRender(() => (\n      <div\n        ref={ rootEl }\n        class=\"v-virtual-scroll\"\n        onScroll={ handleScroll }\n        style={ dimensionStyles.value }\n      >\n        <div\n          class=\"v-virtual-scroll__container\"\n          style={{\n            paddingTop: convertToUnit(paddingTop.value),\n            paddingBottom: convertToUnit(paddingBottom.value),\n          }}\n        >\n          { computedItems.value.map((item, index) => (\n            <VVirtualScrollItem\n              key={ index }\n              dynamicHeight={ !props.itemHeight }\n              onUpdate:height={ height => handleItemResize(index + first.value, height) }\n            >\n              { slots.default?.({ item, index: index + first.value }) }\n            </VVirtualScrollItem>\n          )) }\n        </div>\n      </div>\n    ))\n\n    return {\n      scrollToIndex,\n    }\n  },\n})\n\nexport type VVirtualScroll = InstanceType<typeof VVirtualScroll>\n"],"mappings":"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"}